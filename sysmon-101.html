<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sysmon 101</title>
  <meta name="description" content="This post is about Sysmon.">
  <link rel="canonical" href="http://localhost:4000/sysmon-101">
  <link rel="alternate" type="application/rss+xml" title="BrownInfoSecGuy Feed"
    href="http://localhost:4000/feed.xml">
  
  <link rel="shortcut icon" href="/images/favicon.png" type="image/png" />
  
  <!-- Styles -->
  <link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700,700i%7CNoto+Serif:400,400i,700,700i&display=swap" rel="stylesheet">
  <link href="/assets/css/style.css" rel="stylesheet">
</head>
<body>

  <div id="page" class="site">
    <div class="inner">
      <header class="site-header">
  
  <p class="site-title"><a class="logo-text" href="/">BrownInfoSecGuy</a></p>
  
  <nav class="site-navigation">
    <div class="site-navigation-wrap">
      <h2 class="screen-reader-text">Main navigation</h2>
      <ul class="menu">
        
        
        
        <li class="menu-item ">
          <a class="" href="/">Home</a>
        </li>
        
        
        
        <li class="menu-item ">
          <a class="" href="/tags/">Blog</a>
        </li>
        
        
        
        <li class="menu-item ">
          <a class="" href="/about/">About Me</a>
        </li>
        
        
        
        <li class="menu-item ">
          <a class="" href="/resources">Resources</a>
        </li>
        
      </ul><!-- .menu -->
      <button id="menu-close" class="menu-toggle"><span class="screen-reader-text">Close Menu</span><span
          class="icon-close" aria-hidden="true"></span></button>
    </div><!-- .site-navigation-wrap -->
  </nav><!-- .site-navigation -->
  <button id="menu-open" class="menu-toggle"><span class="screen-reader-text">Open Menu</span><span class="icon-menu" aria-hidden="true"></span></button>
</header>


      <main class="main-content fadeInDown delay_075s">

  <article class="post">
    <header class="post-header">
      <time class="post-date" datetime="2020-09-16">September 16, 2020</time>
      <h1 class="post-title">Sysmon 101</h1>
      <div class="post-meta">
        By <span class="post-author">Sonny</span><span class="post-tags"> in <a href="/tags/#CyberSecurity" rel="tag">CyberSecurity</a></span>
      </div><!-- .post-meta -->
      
      <figure class="post-thumbnail image-card width-wide">
        <img src="/images/Sysmon/Diagram1.jpeg" alt="Sysmon 101">
      </figure><!-- .post-thumbnail -->
      
    </header><!-- .post-header -->
    <div class="post-content">
      <h1 id="introduction-to-sysmon">Introduction to Sysmon</h1>

<p>I decided to write this article about Sysmon after my struggle to find any basic Sysmon 101 article. 
Although there are plenty of articles explaining how to install sysmon, I never found any good article on how sysmon rules 
work together. After some error and trials I was finally able to figure it out.
<!--more--></p>

<p>Log and monitoring is considered an important security control to protect your IT environment. Logging is the first step for
an effective monitoring program. However what and how much to log? is still something that SOC (Security operations centre)
engineers grapple with everyday. This coupled with annual security compliance requirements have made the job of SOC engineers 
very difficult. Moreover it has crippled SOC’s to implement an effective security monitoring program.</p>

<p>Recently, I had the oppurtunity to attend Eric conrads talk at Atlantic Security conference in Halifax. 
Eric mentioned something very interesting about having a compliance SIEM and strategic SIEM. Sysmon is considered to be an 
awesome tool for capturing what is considered to be “relevant” events and something that can feed our strategic SIEM.
I wont be explaining how to install Sysmon here but if you are new to Sysmon I would highly recommend reading official 
<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon">Microsoft documentation</a></p>

<p>However there are two commands that can get you up and running quickly</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sysmon -accepteula –I (This would install sysmon)
sysmon –c &lt;PATH TO CONFIG&gt; (Config File to use)
</code></pre></div></div>
<p>In order to effectively use Sysmon one has to define what events to capture from a Windows system. This is done by using the configuration file for Sysmon. This configuration is an XML file which contain the “Rules” to capture or discard certain events. The XML configuration file for Sysmon has a particular format, you can get more information from the official documentation. However for each event category one need to define filters.</p>

<p>Filters can be explained by taking an example, lets say you want to capture event for launching cmd.exe, how would you define the filter? Well first since its a process creation event we will define the filter under ProcessCreate Tag. Following is the resulting config file to capture the event for cmd.exe.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Sysmon</span> <span class="na">schemaversion=</span><span class="s">”10.4"</span><span class="nt">&gt;</span>
<span class="nt">&lt;HashAlgorithms&gt;</span>md5,sha256<span class="nt">&lt;/HashAlgorithms&gt;</span>
<span class="nt">&lt;CheckRevocation/&gt;</span>
<span class="nt">&lt;EventFiltering&gt;</span>
<span class="nt">&lt;ProcessCreate</span> <span class="na">onmatch=</span><span class="s">”include”</span><span class="nt">&gt;</span>
<span class="nt">&lt;Image</span> <span class="na">condition=</span><span class="s">”contains”</span><span class="nt">&gt;</span>cmd.exe<span class="nt">&lt;/Image&gt;</span>
<span class="nt">&lt;/ProcessCreate&gt;</span>
<span class="nt">&lt;/EventFiltering&gt;</span>
<span class="nt">&lt;/Sysmon&gt;</span>
</code></pre></div></div>
<p>Here is the breakdown of this simple configuration file.</p>

<p><strong>Sysmon Tag:</strong> Used to tell sysmon begining of configuration file along with version of Sysmon running on your system.</p>

<p><strong>Hash Algorithm Tag:</strong> Used to specify the hash algorithms, these algorithms are used to identify files.</p>

<p><strong>Event Filtering Tag:</strong> Used to contain the different Sysmon event categories.</p>

<p><strong>ProcessCreate tag:</strong> Used to tell Sysmon that we are going to start defining filters for the first category of Sysmon event. This category is used to capture events as they relate to process creation. You will also notice we have “onmatch=”include” ” which is telling Sysmon to include the events which match the filters specified beneath this tag. Sysmon will capture all the events matching the filters and discard everything else, the opposite will be true if we had onmatch set to “exclude”.</p>

<p><strong>Image tag:</strong> This is our filter. Dont be confused by Image it it just another name to specify compiled binary.
Now we need to discuss a little more about condition but they are just used to match a condition. The table below provide more information</p>

<p align="center">
    <img src="/images/Sysmon/Diagram2.png" alt="" />
    
    <figcaption align="center" class="figure-caption">Event Filtering categories (Source: Microsoft)</figcaption>
    
</p>

<p>Lets take another example this time we want to capture network events. Here is a basic Sysmon configuration file to capture network events for port 80, 443 and 22. Here is what the config file would look like.</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Sysmon</span> <span class="na">schemaversion=</span><span class="s">”10.4"</span><span class="nt">&gt;</span>
<span class="nt">&lt;HashAlgorithms&gt;</span>md5,sha256<span class="nt">&lt;/HashAlgorithms&gt;</span>
<span class="nt">&lt;EventFiltering&gt;</span>
<span class="nt">&lt;NetworkConnect</span> <span class="na">onmatch=</span><span class="s">”include”</span><span class="nt">&gt;</span>
<span class="nt">&lt;DestinationPort</span> <span class="na">condition=</span><span class="s">”is”</span><span class="nt">&gt;</span>443<span class="nt">&lt;/DestinationPort&gt;</span>
<span class="nt">&lt;DestinationPort</span> <span class="na">condition=</span><span class="s">”is”</span><span class="nt">&gt;</span>80<span class="nt">&lt;/DestinationPort&gt;</span>
<span class="nt">&lt;DestinationPort</span> <span class="na">condition=</span><span class="s">”is”</span><span class="nt">&gt;</span>22<span class="nt">&lt;/DestinationPort&gt;</span>
<span class="nt">&lt;/NetworkConnect&gt;</span>
<span class="nt">&lt;/EventFiltering&gt;</span>
<span class="nt">&lt;/Sysmon&gt;</span>
</code></pre></div></div>
<p>Now lets test this, I can open my browser for testing but I will use PowerShell to test.</p>

<p align="center">
    <img src="/images/Sysmon/Diagram3.png" alt="" />
    
    <figcaption align="center" class="figure-caption">PowerShell cmdlet to access Google.ca on port 443</figcaption>
    
</p>

<p align="center">
    <img src="/images/Sysmon/Diagram4.png" alt="" />
    
    <figcaption align="center" class="figure-caption">Sysmon event generated for the PowerShell cmdlet we ran above.</figcaption>
    
</p>

<p>Now this was easy, but what if we want to filter based on Destination IP? Well we can and its simple, all i need to do is add following to my configuration file</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;DestinationIp condition=“is”&gt;8.8.8.8&lt;/DestinationIp&gt;
</code></pre></div></div>
<p><strong>BUT</strong> here is a <strong>GOTCHA</strong>!!!
First, Here is what my filters look like in my configuration file.</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;NetworkConnect</span> <span class="na">onmatch=</span><span class="s">”include”</span><span class="nt">&gt;</span>
<span class="nt">&lt;DestinationIp</span> <span class="na">condition=</span><span class="s">”is”</span><span class="nt">&gt;</span>8.8.8.8<span class="nt">&lt;/DestinationIp&gt;</span>
<span class="nt">&lt;DestinationPort</span> <span class="na">condition=</span><span class="s">”contains”</span><span class="nt">&gt;</span>80<span class="nt">&lt;/DestinationPort&gt;</span>
<span class="nt">&lt;DestinationPort</span> <span class="na">condition=</span><span class="s">”contains”</span><span class="nt">&gt;</span>443<span class="nt">&lt;/DestinationPort&gt;</span>
<span class="nt">&lt;DestinationPort</span> <span class="na">condition=</span><span class="s">“contains”</span><span class="nt">&gt;</span>53<span class="nt">&lt;/DestinationPort&gt;</span>
<span class="nt">&lt;/NetworkConnect&gt;</span>
</code></pre></div></div>
<p>But when I use this file I will only see logs if the “DestinationIp” is 8.8.8.8 <strong>AND</strong> “DestionationPort” is 80 <strong>OR</strong> 443 <strong>OR</strong> 53. Any other destination IP and I wont see any events being generated.
Let’s make it more interesting what if I have following in my Config.xml file</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;NetworkConnect</span> <span class="na">onmatch=</span><span class="s">”include”</span><span class="nt">&gt;</span>
<span class="nt">&lt;Image</span> <span class="na">condition=</span><span class="s">”contains”</span><span class="nt">&gt;</span>chrome.exe<span class="nt">&lt;/Image&gt;</span>
<span class="nt">&lt;Image</span> <span class="na">condition=</span><span class="s">”contains”</span><span class="nt">&gt;</span>svchost.exe<span class="nt">&lt;/Image&gt;</span>
<span class="nt">&lt;Image</span> <span class="na">condition=</span><span class="s">”contains”</span><span class="nt">&gt;</span>powershell<span class="nt">&lt;/Image&gt;</span>
<span class="nt">&lt;DestinationIp</span> <span class="na">condition=</span><span class="s">”is”</span><span class="nt">&gt;</span>8.8.8.8<span class="nt">&lt;/DestinationIp&gt;</span>
<span class="nt">&lt;DestinationPort</span> <span class="na">condition=</span><span class="s">”contains”</span><span class="nt">&gt;</span>80<span class="nt">&lt;/DestinationPort&gt;</span>
<span class="nt">&lt;DestinationPort</span> <span class="na">condition=</span><span class="s">”contains”</span><span class="nt">&gt;</span>443<span class="nt">&lt;/DestinationPort&gt;</span>
<span class="nt">&lt;DestinationPort</span> <span class="na">condition=</span><span class="s">“contains”</span><span class="nt">&gt;</span>53<span class="nt">&lt;/DestinationPort&gt;</span>
<span class="nt">&lt;/NetworkConnect&gt;</span>
</code></pre></div></div>
<p>Well this means that I will only see log entries if:
“Image/Process” contains chrome.exe OR svchost.exe OR powershell AND “Destination IP” is 8.8.8.8 AND “Destination Port” is 80 OR 443 OR 53.</p>

<p>So it means that if you are filtering on same condition its the OR switch but if you keep adding filter it’s AND condition. I banged my head against the computer for 2 hours before I figured this out.</p>

<p>I hope this atricle would have helped you to understand how Sysmon rules works. If you want to learn more about Sysmon here is a list of few resources</p>

<p><strong>Sources:</strong></p>

<p>https://github.com/SwiftOnSecurity/sysmon-config</p>

<p>https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon</p>

<p>https://cqureacademy.com/blog/server-monitoring/sysmon</p>

<p>https://posts.specterops.io/working-with-sysmon-configurations-like-a-pro-through-better-tooling-be7ad7f99a47</p>

<p>https://www.darkoperator.com/blog/2014/8/8/sysinternals-sysmon</p>

    </div><!-- .post-content -->
    <div class="post-share">
      <span>Share:</span>
      <a target="_blank"
        href="https://twitter.com/intent/tweet?text=Sysmon%20101&amp;url=http://localhost:4000/sysmon-101" rel="noopener">Twitter</a>
      <a target="_blank"
        href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/sysmon-101&amp;t=Sysmon%20101" rel="noopener">Facebook</a>
    </div><!-- .share-post -->
    <div class="author-box">
      
      <div class="author-avatar" style="background-image: url('images/HEADSHOT.png')"><span class="screen-reader-text">Sonny's Picture</span></div>
      
      <div class="author-details">
        <h2 class="author-title">About Sonny</h2>
        <div class="author-bio"><p>Sonny is a CyberSecurity enthusiast who currently resides in Halifax, Nova Scotia. Apart from CyberSecurity Sonny is pasionate about PowerShell.</p>
</div>
        
        <span class="author-location">Nova Scoita, Canada</span>
        
        
        <span class="author-website"><a href="https://browninfosecguy.com" target="_blank" rel="noopener">https://browninfosecguy.com</a></span>
        
      </div><!-- .author-details -->
    </div><!-- .author-box -->
  </article><!-- .post -->

  

</main><!-- .main-content -->
      <footer class="site-footer">
  <div class="offsite-links">
    
      
<a href="https://twitter.com/browninfosecguy" target="_blank" rel="noopener">
  <span class="fa-twitter" aria-hidden="true"></span>
  <span class="screen-reader-text">Twitter</span>
</a>

<a href="https://github.com/browninfosecguy" target="_blank" rel="noopener">
  <span class="fa-github" aria-hidden="true"></span>
  <span class="screen-reader-text">GitHub</span>
</a>

    
  </div><!-- .offsite-links -->
  <div class="footer-bottom">
    <div class="site-info">
      <p>© Scriptor all rights reserved. Theme by <a href="https://www.justgoodthemes.com">JustGoodThemes</a>.</p>

    </div><!-- .site-info -->
    <a href="#page" id="back-to-top" class="back-to-top"><span class="screen-reader-text">Back to the top </span>&#8593;</a>
  </div><!-- .footer-bottom -->
</footer><!-- .site-footer -->

    </div><!-- .inner -->
  </div><!-- .site -->

  <!-- Scripts -->
  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');
</script>
  
  <script src="/assets/js/plugins.js"></script>
  <script src="/assets/js/custom.js"></script>

</body>
</html>